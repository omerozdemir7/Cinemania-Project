{"version":3,"file":"library-D5ojg7xl.js","sources":["../../src/pages/library/library.js"],"sourcesContent":["import { fetchMovieDetails, fetchGenres } from '../../services/api.js';\nimport { Modal } from '../../components/modal/modal.js';\n\n\n// ===== DOM =====\nconst libraryListEl  = document.getElementById('library-list');\nconst emptyLibraryEl = document.getElementById('empty-library');\nconst genreFilter    = document.getElementById('genre-filter');\nconst loadMoreBtn    = document.getElementById('load-more-btn');\n\n// ===== STATE =====\nlet GENRES = {};                  \nlet currentLibraryView = [];     \nlet displayedCount = 0;\nconst LOAD_COUNT = 9;\n\n// ===== UTILS =====\nfunction createStarRating(vote) {\n  const rating = (Number(vote) || 0) / 2;\n  let stars = '';\n  for (let i = 1; i <= 5; i++) {\n    if (rating >= i) {\n      stars += `\n        <svg class=\"library__icon--star-full\" width=\"20\" height=\"20\">\n          <use xlink:href=\"${import.meta.env.BASE_URL}images/icon.svg#icon-full-star\"></use>\n        </svg>`;\n    } else if (rating >= i - 0.5) {\n      stars += `\n        <svg class=\"library__icon--star-half\" width=\"20\" height=\"20\" viewBox=\"0 0 32 32\">\n          <path fill=\"none\" stroke=\"#f87719\" stroke-linejoin=\"round\" stroke-linecap=\"butt\"\n                stroke-miterlimit=\"4\" stroke-width=\"2\"\n                d=\"M30 13h-10.75l-3.25-10-3.25 10h-10.75l8.75 6-3.375 10 8.625-6.25 8.625 6.25-3.375-10 8.75-6z\"></path>\n          <path d=\"M16 3v19.75l-8.625 6.25 3.375-10-8.75-6h10.75l3.25-10z\" fill=\"#f87719\"></path>\n        </svg>`;\n    } else {\n      stars += `\n        <svg class=\"library__icon--star-empty\" width=\"20\" height=\"20\">\n          <use xlink:href=\"${import.meta.env.BASE_URL}images/icon.svg#icon-empty-star\"></use>\n        </svg>`;\n    }\n  }\n  return stars;\n}\n\nfunction getBrightness(rgb) {\n  const m = rgb.match(/\\d+/g);\n  if (!m) return 255;\n  const [r, g, b] = m.map(Number);\n  return (r * 299 + g * 587 + b * 114) / 1000;\n}\n\n// ===== LIBRARY RENDER =====\nfunction displayLibrary(movies, reset = true) {\n  if (reset) {\n    libraryListEl.innerHTML = '';\n    displayedCount = 0;\n    currentLibraryView = Array.isArray(movies) ? movies : [];\n  }\n\n  const batch = currentLibraryView.slice(displayedCount, displayedCount + LOAD_COUNT);\n  const html = batch.map(movie => {\n    if (!movie.poster_path) return '';\n    const year   = movie.release_date ? movie.release_date.slice(0, 4) : '—';\n    const genres = (movie.genre_ids || [])\n      .map(id => GENRES[id])\n      .filter(Boolean)\n      .join(', ') || '—';\n    const stars  = createStarRating(movie.vote_average);\n\n    return `\n      <li id=\"${movie.id}\" class=\"library__card\"\n          style=\"\n            background-image:url(https://image.tmdb.org/t/p/w500${movie.poster_path});\n            background-size:cover;background-position:center;\n            width:100%;max-width:395px;aspect-ratio:395/574;border-radius:12px;overflow:hidden;position:relative;\">\n        <div class=\"library__card-content\"\n             style=\"position:absolute;bottom:0;width:100%;\n                    background:linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0));\n                    color:#fff;padding:10px;box-sizing:border-box;\">\n          <h3 style=\"margin:0;font-size:18px;\">${movie.title}</h3>\n          <p style=\"margin:2px 0;font-size:14px; color: #fff;\">${genres} | ${year}</p>\n          <div>${stars}</div>\n        </div>\n      </li>`;\n  }).join('');\n\n  libraryListEl.insertAdjacentHTML('beforeend', html);\n  displayedCount += batch.length;\n\n  if (displayedCount < currentLibraryView.length) {\n    loadMoreBtn.classList.remove('hidden');\n  } else {\n    loadMoreBtn.classList.add('hidden');\n  }\n\n  attachCardClickEvents();\n}\n\nfunction loadLibrary() {\n  const library = JSON.parse(localStorage.getItem('library')) || [];\n  if (!library.length) {\n    emptyLibraryEl.style.display = 'flex';\n    libraryListEl.innerHTML = '';\n    genreFilter?.parentElement && (genreFilter.parentElement.style.display = 'none');\n    loadMoreBtn?.classList.add('hidden');\n    return;\n  }\n\n  emptyLibraryEl.style.display = 'none';\n  genreFilter?.parentElement && (genreFilter.parentElement.style.display = 'flex');\n\n  const set = new Set();\n  library.forEach(m => (m.genre_ids || []).forEach(id => GENRES[id] && set.add(GENRES[id])));\n\n  if (genreFilter) {\n    genreFilter.innerHTML = `<option value=\"all\">Genre</option>` +\n      [...set].map(n => `<option value=\"${n}\">${n}</option>`).join('');\n  }\n\n  displayLibrary(library);\n}\n\nfunction attachCardClickEvents() {\n  document.querySelectorAll('.library__card').forEach(card => {\n    card.removeEventListener('click', card._clickHandler);\n    const handler = () => {\n      const id = Number(card.id);\n      const library = JSON.parse(localStorage.getItem('library')) || [];\n      const movie = library.find(m => Number(m.id) === id);\n      if (movie) Modal.renderMovie(movie);\n    };\n    card._clickHandler = handler;\n    card.addEventListener('click', handler);\n  });\n}\n\ndocument.addEventListener('click', e => {\n  if (e.target?.matches?.('[data-action=\"toggle-library\"]')) {\n    setTimeout(() => loadLibrary(), 0);\n  }\n});\n\n// ===== EVENTS =====\nloadMoreBtn?.addEventListener('click', () => displayLibrary(currentLibraryView, false));\ngenreFilter?.addEventListener('change', e => {\n  const value = e.target.value;\n  const all = JSON.parse(localStorage.getItem('library')) || [];\n  if (value === 'all') return displayLibrary(all);\n  const filtered = all.filter(m => (m.genre_ids || []).some(id => GENRES[id] === value));\n  displayLibrary(filtered);\n});\n\n(function styleSelectByTheme() {\n  if (!genreFilter) return;\n  const bodyBg = window.getComputedStyle(document.body).backgroundColor;\n  const brightness = getBrightness(bodyBg);\n  const textColor = brightness < 128 ? '#fff' : '#000';\n  genreFilter.style.backgroundColor = bodyBg;\n  genreFilter.style.color = textColor;\n  genreFilter.style.border = `1px solid ${brightness < 128 ? '#fff' : '#000'}`;\n})();\n\n// ===== INIT =====\n(async function init() {\n  try {\n    const genresRes = await fetchGenres();\n    const list = genresRes?.genres || [];\n    GENRES = list.reduce((acc, g) => ((acc[g.id] = g.name), acc), {});\n\n    loadLibrary();\n  } catch (err) {\n    console.error('Library init error:', err);\n  }\n})();\n"],"names":["libraryListEl","emptyLibraryEl","genreFilter","loadMoreBtn","GENRES","currentLibraryView","displayedCount","LOAD_COUNT","createStarRating","vote","rating","stars","getBrightness","rgb","m","r","g","b","displayLibrary","movies","reset","batch","html","movie","year","genres","id","attachCardClickEvents","loadLibrary","library","set","n","card","handler","Modal","e","_b","_a","value","all","filtered","bodyBg","brightness","textColor","genresRes","fetchGenres","acc","err"],"mappings":"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"}